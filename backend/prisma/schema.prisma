generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id            String    @id @default(cuid())
  clerkId       String    @unique
  email         String    @unique
  name          String?
  company       String?
  cui           String?   // Romanian company ID
  tier          Tier      @default(FREE)
  language      String    @default("ro")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  documents     Document[]
  invoices      Invoice[]
  vatReports    VATReport[]
  saftReports   SAFTReport[]
  employees     Employee[]
  aiQueries     AIQuery[]
  auditLogs     AuditLog[]

  @@index([clerkId])
  @@index([email])
}

enum Tier {
  FREE
  PRO
  BUSINESS
}

// Document Management (OCR)
model Document {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id])
  filename      String
  fileUrl       String
  fileType      String
  fileSize      Int
  status        DocStatus     @default(PENDING)
  ocrData       Json?
  extractedText String?
  confidence    Float?
  createdAt     DateTime      @default(now())
  processedAt   DateTime?

  invoice       Invoice?

  @@index([userId])
  @@index([status])
}

enum DocStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Invoice Management
model Invoice {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  documentId      String?       @unique
  document        Document?     @relation(fields: [documentId], references: [id])

  invoiceNumber   String
  invoiceDate     DateTime
  dueDate         DateTime?
  type            InvoiceType   @default(RECEIVED)
  status          InvoiceStatus @default(DRAFT)

  // Supplier/Customer
  partnerName     String
  partnerCui      String?
  partnerAddress  String?

  // Amounts
  netAmount       Decimal       @db.Decimal(12, 2)
  vatRate         Decimal       @db.Decimal(5, 2)
  vatAmount       Decimal       @db.Decimal(12, 2)
  grossAmount     Decimal       @db.Decimal(12, 2)
  currency        String        @default("RON")

  // e-Factura
  efacturaId      String?
  efacturaStatus  String?
  spvSubmitted    Boolean       @default(false)
  spvSubmittedAt  DateTime?

  // SAGA sync
  sagaSynced      Boolean       @default(false)
  sagaId          String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([userId])
  @@index([invoiceDate])
  @@index([type])
}

enum InvoiceType {
  ISSUED
  RECEIVED
}

enum InvoiceStatus {
  DRAFT
  PENDING
  APPROVED
  SUBMITTED
  PAID
  CANCELLED
}

// VAT Reports
model VATReport {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id])

  period        String      // YYYY-MM
  vatCollected  Decimal     @db.Decimal(12, 2)
  vatDeductible Decimal     @db.Decimal(12, 2)
  vatPayable    Decimal     @db.Decimal(12, 2)
  vatRate       Decimal     @db.Decimal(5, 2) @default(21)

  status        ReportStatus @default(DRAFT)
  submittedAt   DateTime?
  anafRef       String?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([userId, period])
  @@index([userId])
}

// SAF-T D406 Reports
model SAFTReport {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id])

  period        String      // YYYY-MM
  reportType    String      @default("D406")
  xmlUrl        String?
  xmlSize       Int?

  // Validation
  validated     Boolean     @default(false)
  validatedAt   DateTime?
  validationResult Json?

  // Submission
  status        ReportStatus @default(DRAFT)
  submittedAt   DateTime?
  spvRef        String?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([userId, period])
  @@index([userId])
}

enum ReportStatus {
  DRAFT
  VALIDATING
  VALIDATED
  SUBMITTED
  ACCEPTED
  REJECTED
}

// HR Module
model Employee {
  id            String      @id @default(cuid())
  userId        String      // Company owner
  user          User        @relation(fields: [userId], references: [id])

  firstName     String
  lastName      String
  email         String
  cnp           String?     // Romanian personal ID
  position      String
  department    String?

  hireDate      DateTime
  salary        Decimal     @db.Decimal(10, 2)
  contractType  String      @default("FULL_TIME")

  status        EmployeeStatus @default(ACTIVE)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  payrolls      Payroll[]

  @@index([userId])
}

enum EmployeeStatus {
  ACTIVE
  ON_LEAVE
  TERMINATED
}

model Payroll {
  id            String      @id @default(cuid())
  employeeId    String
  employee      Employee    @relation(fields: [employeeId], references: [id])

  period        String      // YYYY-MM
  grossSalary   Decimal     @db.Decimal(10, 2)
  netSalary     Decimal     @db.Decimal(10, 2)
  taxes         Decimal     @db.Decimal(10, 2)
  contributions Decimal     @db.Decimal(10, 2)

  status        PayrollStatus @default(PENDING)
  paidAt        DateTime?

  createdAt     DateTime    @default(now())

  @@unique([employeeId, period])
  @@index([employeeId])
}

enum PayrollStatus {
  PENDING
  APPROVED
  PAID
}

// AI Queries Log
model AIQuery {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id])

  question      String
  answer        String
  model         String      @default("grok")
  tokens        Int?
  latencyMs     Int?

  createdAt     DateTime    @default(now())

  @@index([userId])
  @@index([createdAt])
}

// Audit Log for Compliance
model AuditLog {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id])

  action        String
  entity        String
  entityId      String?
  details       Json?
  ipAddress     String?

  createdAt     DateTime    @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}
